#!/usr/bin/env python
"""License.sh

Usage:
  license-sh config
  license-sh [options]
  license-sh <path> [options]
  license-sh (-h | --help)
  license-sh --version

Options:
  -h --help                           Show this screen.
  -o <reporter> --output <reporter>   Output [default: console].
  -t --tree                           Show full dependency tree.
  -d --debug                          Debug mode
  --version                           Show version.
"""

from PyInquirer import prompt

from license_sh.commands import config_cmd
from license_sh.config import whitelist_licenses, get_config
from license_sh.helpers import get_dependency_tree_with_licenses
from license_sh.reporters.ConsoleReporter import ConsoleReporter
from license_sh.reporters.JSONConsoleReporter import JSONConsoleReporter

from license_sh.version import __version__

from docopt import docopt

from license_sh.project_identifier import get_project_types, ProjectType
from license_sh.runners.npm import NpmRunner
from license_sh.runners.yarn import YarnRunner
from license_sh.runners.python import PythonRunner
from license_sh.runners.maven import MavenRunner

try:
    from license_sh_private.licenses import COMMERCIAL_LICENSES as WHITELIST
except ImportError:
    WHITELIST = []

if __name__ == "__main__":
    arguments = docopt(__doc__, version=__version__)

    config_mode = arguments["config"]
    path = arguments["<path>"] or "."
    output = arguments["--output"]
    tree = arguments["--tree"]
    debug = arguments["--debug"]

    config = get_config(path)

    # TODO test this data transformation
    config_ignored_packages = config.get("ignored_packages", {})
    ignored_packages_map = {
        e.value: config_ignored_packages.get(e.value, {}) for e in ProjectType
    }

    WHITELIST += config.get("whitelist", [])

    if config_mode:
        config_cmd(path, config)
        exit(0)

    silent = output == "json" or debug

    # docopt guarantees that output variable contains either console or json
    Reporter = {"console": ConsoleReporter, "json": JSONConsoleReporter}[output]

    project_types = get_project_types(path)
    ignored_packages = []

    dep_tree = None
    license_map = {}

    if ProjectType.PYTHON_PIPENV in project_types:
        runner = PythonRunner(path, silent, debug)
        dep_tree, license_map = runner.check()
        ignored_packages = ignored_packages_map[ProjectType.PYTHON_PIPENV.value]

    if ProjectType.NPM in project_types:
        runner = NpmRunner(path, silent, debug)
        dep_tree, license_map = runner.check()
        ignored_packages = ignored_packages_map[ProjectType.PYTHON_PIPENV.value]

    if ProjectType.MAVEN in project_types:
        runner = MavenRunner(path, silent, debug)
        dep_tree, license_map = runner.check()
        ignored_packages = ignored_packages_map[ProjectType.PYTHON_PIPENV.value]

    if ProjectType.YARN in project_types:
        runner = YarnRunner(path, silent, debug)
        dep_tree, license_map = runner.check()
        ignored_packages = ignored_packages_map[ProjectType.PYTHON_PIPENV.value]

    filtered_dep_tree, licenses_not_found = get_dependency_tree_with_licenses(
        dep_tree, WHITELIST, ignored_packages, get_full_tree=tree
    )

    Reporter.output(filtered_dep_tree)

    if licenses_not_found and output != "json":
        questions = [
            {
                "type": "confirm",
                "message": "Do you want to add some of the licenses to your whitelist?",
                "name": "continue",
                "default": True,
            }
        ]

        answers = prompt(questions)
        if answers["continue"]:
            questions = [
                {
                    "type": "checkbox",
                    "qmark": "ðŸ“‹",
                    "message": "Whitelist licenses",
                    "name": "whitelist",
                    "choices": [{"name": license} for license in licenses_not_found],
                }
            ]
            answers = prompt(questions)
            if answers["whitelist"]:
                whitelist_licenses(path, answers["whitelist"])

                config = get_config(path)
                filtered_dep_tree, licenses_not_found = get_dependency_tree_with_licenses(
                    dep_tree, config.get("whitelist", [])
                )

    has_issues: bool = filtered_dep_tree.height > 0
    exit(1 if has_issues else 0)
